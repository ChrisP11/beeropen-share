{% extends "base.html" %}
{% load static %}

{% block title %}Event Management · Beer Open{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-3">Event Management</h1>

  <!-- Current EventSettings -->
  <div class="card mb-4">
    <div class="card-header">Current Settings</div>
    <div class="card-body">
      <div><strong>Name:</strong> {{ settings.event_name }}</div>
      <div><strong>Event date:</strong> {{ settings.event_date }}</div>
      <div><strong>Course:</strong> {{ settings.scoring_course|default:"—" }}</div>
      <div><strong>Tee:</strong> {{ settings.scoring_tee|default:"—" }}</div>
      <div><strong>Leaderboard public:</strong> {{ settings.leaderboard_public|yesno:"Yes,No" }}</div>
      <a href="{% url 'event_setup' %}" class="btn btn-primary mt-3">
        Kick off a new event
      </a>
    </div>
  </div>

  <!-- Configured / Active event dates -->
  {% if events %}
  <div class="card">
    <div class="card-header">Event Dates</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Configured?</th>
              <th>Course / Tee</th>
              <th class="text-center">Open Rounds</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for e in events %}
              <tr class="{% if e.is_current %}table-info{% endif %}">
                <td>{{ e.event_date }}</td>
                <td>
                  {% if e.is_current %}
                    <span class="badge bg-primary">Current</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="small">
                  {% if e.course %}{{ e.course }}{% else %}—{% endif %}
                  {% if e.course and e.tee %} — {{ e.tee }}{% endif %}
                </td>
                <td class="text-center">
                  {% if e.open_rounds > 0 %}
                    <span class="badge bg-warning text-dark">{{ e.open_rounds }}</span>
                  {% else %}
                    <span class="badge bg-success">0</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <!-- Create rounds for all teams (disabled if any are already open) -->
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="event_date" value="{{ e.event_date|date:'Y-m-d' }}">
                    <button class="btn btn-outline-primary btn-sm"
                            name="action" value="create_rounds"
                            {% if e.open_rounds > 0 %}disabled{% endif %}
                            title="Create empty rounds for all teams">
                      Create rounds
                    </button>
                  </form>

                  <!-- Close event (finalize all open rounds) -->
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="event_date" value="{{ e.event_date|date:'Y-m-d' }}">
                    <button class="btn btn-danger btn-sm"
                            name="action" value="close_event"
                            {% if e.open_rounds == 0 %}disabled{% endif %}
                            onclick="return confirm('Finalize all open rounds for {{ e.event_date }}?');">
                      Close
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
    <div class="alert alert-secondary">No configured or active events yet.</div>
  {% endif %}
</div>
{% endblock %}
